# PostgreSQL Audit Trail

This is an improvement for an PgSQL adit trail.

## Installation

Execute the *.sql* scipts in order as shown
| Script | Description |
| ------ | ------ |
| 0__z_logs__schema.sql | Crates the Schema **z_logs** |
| 1__z_logs__table_global_logs.sql | Creates the table **global_logs** |
| 2__z_logs__table_log_controls.sql | Creates the table **log_controls** |
| 3__z_log__function_current_user_id.sql | Creates the function **current_user_id** |
| 4__z_logs__function_audit_control.sql | Creates the function **audit_control** |
| 5__z_logs__function_globallogs.sql | Creates the function **globallogs** |
| 6__z_logs__trigger_audit_control.sql | Created the trigger **audit_control** |
| 7__z_logs__grants.sql | Shows example of grant permissions over objets |

### Schema "z_logs"

Will host all the objets (tiggers, functions and tables) related with the Audit Trail implementation.

### Table "z_logs.log_controls"

Is where you configure how sensitive will be your audit trail in the scale from 0 to 7.

| Value | Conditions |
| ------ | ------ |
| 0 | Audit Trail **DISABLED** |
| 1 | AFTER UPDATE |
| 2 | AFTER INSERT |
| 3 | AFTER DELETE |
| 4 | AFTER INSERT OR UPDATE |
| 5 | AFTER UPDATE OR DELETE |
| 6 | AFTER INSERT OR DELETE |
| 7 | AFTER INSERT OR UPDATE OR DELETE |

Automatically after any update in the table, the trigger **t_audit_control** (is configured in the table "log_controls") will create update or disable the triggers that generate audit trails.

### Table "z_logs.global_logs"

This table will contain all audit trails generated by the configuration given in the table **z_logs.log_controls**

| Column | Description |
| ------ | ------ |
| id | Audit Trail **DISABLED** |
| schema_name | Name of the schema of the table affected |
| table_name | Name of the table afacted |
| db_role | Name of the DB role that executed the action |
| action_datetime | Data and time of the action |
| action | Action Executed: INSERT, UPDATE or UDPATE |
| original_data | The previus data before modificatio or delitation |
| new_data | The new data added or updated |
| query_executed | The query that was executed |
| ui_user | User ID of the interface that executed the action |
